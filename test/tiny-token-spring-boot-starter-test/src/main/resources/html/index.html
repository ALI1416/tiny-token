<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Title</title>
</head>

<body>
<div>
  <label for="urlText">URL：</label><input id="urlText" type="text" value="http://127.0.0.1:8080/">
</div>
<div>
  <label for="headerText">Header：</label><input id="headerText" type="text" value="token">
</div>
<div>
  <label for="idText">ID：</label><input id="idText" type="text" value="1">
</div>
<div>
  <input id="loginBtn" type="button" value="登录">
  <input id="logoutBtn" type="button" value="注销">
</div>
<div id="tipDiv"></div>
<script>
  let urlText = document.getElementById('urlText')
  let headerText = document.getElementById('headerText')
  let idText = document.getElementById('idText')
  let loginBtn = document.getElementById('loginBtn')
  let logoutBtn = document.getElementById('logoutBtn')
  let tipDiv = document.getElementById('tipDiv')

  let token = localStorage[headerText.value]

  // 进入页面判断登录状态
  if (token === undefined) {
    tipDiv.innerText = '未登录'
  } else {
    getId().then(res => {
      if (res.length === 0) {
        tipDiv.innerText = '登录已过期'
        localStorage.removeItem(headerText.value)
        token = undefined
      } else {
        tipDiv.innerText = '已登录账号[' + res + '] token[' + token + ']'
      }
    })
  }

  /**
   * 点击登录按钮
   */
  loginBtn.addEventListener('click', () => {
    login(idText.value).then(res => {
      localStorage[headerText.value] = res
      token = res
      tipDiv.innerText = '登录成功，账号[' + idText.value + '] token[' + res + ']'
    })
  })

  /**
   * 点击注销按钮
   */
  logoutBtn.addEventListener('click', () => {
    logout().then(res => {
      if (res === 'true') {
        tipDiv.innerText = '注销token[' + token + ']成功'
      } else {
        tipDiv.innerText = '注销token[' + token + ']失败'
      }
      localStorage.removeItem(headerText.value)
      token = undefined
    })
  })

  /**
   * 获取登录id
   */
  function getId() {
    return myFetch('getId')
  }

  /**
   * 登录
   */
  function login(id) {
    return myFetch('setToken?id=' + id)
  }

  /**
   * 注销
   */
  function logout() {
    return myFetch('deleteByToken')
  }

  function myFetch(path) {
    return fetch(urlText.value + path, {headers: {mode: 'no-cors', [headerText.value]: token}}).then(res => res.text())
  }
</script>
</body>

</html>